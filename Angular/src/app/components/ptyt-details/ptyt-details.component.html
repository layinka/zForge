<!-- Staking Success Celebration -->
@if (stakingResult() && stakingResult()!.showCelebration) {
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-success border-0 shadow-sm celebration-alert">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-3">
                <div class="celebration-icon me-3">
                  <i class="bi bi-check-circle-fill text-success"></i>
                </div>
                <div>
                  <h4 class="alert-heading mb-1">
                    <i class="bi bi-party-popper me-2"></i>
                    Staking Successful! ðŸŽ‰
                  </h4>
                  <p class="mb-0 text-muted">Your tokens have been successfully staked</p>
                </div>
              </div>
              
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="staking-detail">
                    <small class="text-muted d-block">Token Staked</small>
                    <strong>{{ stakingResult()!.underlyingTokenInfo?.symbol }}</strong>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="staking-detail">
                    <small class="text-muted d-block">Maturity Date</small>
                    <strong>{{ formatMaturityDate(stakingResult()!.maturity) }}</strong>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="staking-detail">
                    <small class="text-muted d-block">Expected APY</small>
                    <strong class="text-success">
                      {{ stakingResult()!.syTokenInfo ? calculateAPY(stakingResult()!.syTokenInfo!.yieldRate).toFixed(2) : '0' }}%
                    </strong>
                  </div>
                </div>
              </div>
              
              <div class="mt-3">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  You will receive PT and YT tokens representing your staked position. Check your balances below.
                </small>
              </div>
            </div>
            
            <button type="button" class="btn-close" (click)="dismissStakingResult()"></button>
          </div>
        </div>
      </div>
    </div>
  }
  
  <div class="row">
    <div class="col-12">
      <div class="text-center mb-5">
        <h1 class="gradient-text display-4 fw-bold">PT & YT Management</h1>
        <p class="lead text-muted">
          Manage your Principal and Yield tokens - merge, redeem, and claim yields
        </p>
      </div>
    </div>
  </div>
  
  <div class="row g-4">
    
  
    <!-- PT/YT Balances -->
    <div class="col-lg-8 order-2 order-md-1">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            <i class="bi bi-wallet me-2"></i>
            Your PT & YT Tokens
          </h4>
        </div>
        <div class="card-body">
          <!-- PT Tokens -->
          <div class="mb-4">
            <h5 class="text-primary mb-3">
              <i class="bi bi-shield-check me-2"></i>
              Principal Tokens (PT)
            </h5>
            @if (filteredPTTokens().length > 0) {
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Token</th>
                      <th>Balance</th>
                      <th>Maturity</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (ptToken of filteredPTTokens(); track ptToken.address) {
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="badge bg-primary">{{  ptToken.symbol || selectedSYToken()?.symbol  }}</span>
                            <!-- {{ ptToken.name }} -->
                          </div>
                        </td>
                        <td>{{ parseFloat(ptToken.balance || '0') | number:'1.0-4' }}</td>
                        <td>{{ getPTMaturity(ptToken.address) }}</td>
                        <td>
                          @if (isPTMatured(ptToken.address)) {
                            <span class="badge bg-success">Redeemable</span>
                          } @else {
                            <span class="badge bg-warning">Locked</span>
                          }
                        </td>
                        <td>
                          <!-- @if (isPTMatured(ptToken.address) && parseFloat(ptToken.balance) > 0) { -->
                            <button 
                              class="btn btn-success btn-sm"
                              (click)="redeemPT(ptToken.address)"
                              [disabled]="!(isPTMatured(ptToken.address) && parseFloat(ptToken.balance) > 0) || isProcessing()">
                              Redeem
                            </button>
                          <!-- } @else {
                            <span class="text-muted">-</span>
                          } -->
                          <!-- <button 
                            class="btn btn-warning btn-sm ms-2"
                            (click)="tradePT(ptToken.address)"
                            [disabled]="isProcessing()">
                            Trade
                          </button> -->
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="text-center py-4">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="text-muted mt-2">
                  @if (selectedSYToken() !== null) {
                    No PT tokens found for selected SY token
                  } @else {
                    No PT tokens with balance found. Stake tokens to generate PT tokens.
                  }
                </p>
              </div>
            }
          </div>
  
          <!-- YT Tokens -->
          <div>
            <h5 class="text-warning mb-3">
              <i class="bi bi-graph-up me-2"></i>
              Yield Tokens (YT)
            </h5>
            @if (filteredYTTokens().length > 0) {
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Token</th>
                      <th>Balance</th>
                      <th>Claimable Yield</th>
                      <th>Expiry</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (ytToken of filteredYTTokens(); track ytToken.address) {
                      <tr>
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="token-badge bg-warning me-2">{{ ytToken.symbol }}</span>
                            <!-- {{ ytToken.name }} -->
                          </div>
                        </td>
                        <td>{{ parseFloat(ytToken.balance || '0') | number:'1.0-4' }}</td>
                        <td>
                          <span class="text-success fw-semibold">
                            {{ getYTClaimableYield(ytToken.address) }}
                          </span>
                        </td>
                        <td>{{ getYTExpiry(ytToken.address) }}</td>
                        <td>
                          @if (isYTExpired(ytToken.address)) {
                            <span class="badge bg-danger">Expired</span>
                          } @else {
                            <span class="badge bg-success">Active</span>
                          }
                        </td>
                        <td>
                          <!-- @if (!isYTExpired(ytToken.address) && parseFloat(getYTClaimableYield(ytToken.address)) > 0) { -->
                            <button 
                              class="btn btn-warning btn-sm"
                              (click)="claimYield(ytToken.address)"
                              [disabled]="!(!isYTExpired(ytToken.address) && parseFloat(getYTClaimableYield(ytToken.address)) > 0) || isProcessing()">
                              Claim
                            </button>
                          <!-- } @else { -->
                            
                            <button 
                              class="btn btn-warning btn-sm ms-2"
                              (click)="tradeYT(ytToken.address)"
                              [disabled]="isProcessing()">
                              Trade
                            </button>
                          <!-- } -->
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="text-center py-4">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="text-muted mt-2">
                  @if (selectedSYToken() !== null) {
                    No YT tokens found for selected SY token
                  } @else {
                    No YT tokens with balance found. Stake tokens to generate YT tokens.
                  }
                </p>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  
    <!-- Actions Panel -->
    <div class="col-lg-4 order-1 order-md-2">
      <!-- Filter by SY Token -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-funnel me-2"></i>
            Filter by SY Token
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Select Yield Token to Filter</label>
            <select 
              class="form-select" 
              [ngModel]="selectedSYToken()"
              (ngModelChange)="onSYTokenFilterChange($event)"
              [compareWith]="compareTokens">
              <option [ngValue]="null">Show All PT/YT Tokens</option>
              @for (syToken of syTokensList(); track syToken.underlying) {
                <option [ngValue]="syToken">
                  {{ syToken.name }}
                </option>
              }
            </select>
          </div>
          @if (selectedSYToken()) {
            <div class="alert alert-info">
              <small>
                <strong>Filtering:</strong>
                <h3 class="card-title">PT/YT Tokens for {{ selectedSYToken()?.name || 'All' }}</h3>
              </small>
            </div>
          }
        </div>
      </div>
      
      <!-- Merge PT + YT -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-arrow-left-right me-2"></i>
            Merge PT + YT
          </h5>
        </div>
        <div class="card-body">
          <form (ngSubmit)="mergePTYT()" #mergeForm="ngForm">
            <div class="mb-3">
              <label class="form-label fw-semibold">Select SY Token</label>
              <select 
                class="form-select" 
                [(ngModel)]="selectedSYForMerge" 
                name="selectedSYForMerge"
                required>
                <option value="">Choose SY token...</option>
                @for (syToken of syTokensList(); track syToken.underlying) {
                  <!-- @if (canMerge(syToken.underlying)) { -->
                    <option [value]="syToken.underlying">
                      {{ syToken.name }} <!--  ({{ parseFloat(syToken.balance || '0') | number:'1.0-4' }}) -->
                    </option>
                  <!-- } -->
                }
              </select>
            </div>
  
            @if (selectedSYForMerge) {
              <div class="mb-3">
                <label class="form-label fw-semibold">Amount to Merge</label>
                <div class="input-group">
                  <input 
                    type="number" 
                    class="form-control" 
                    [(ngModel)]="mergeAmount" 
                    name="mergeAmount"
                    placeholder="0.0"
                    step="0.001"
                    min="0"
                    [max]="100000"
                    required>
                  <!-- <button 
                    type="button" 
                    class="btn btn-outline-secondary"
                    (click)="setMaxMergeAmount()">
                    MAX
                  </button> -->
                </div>
                <!-- <small class="text-muted">
                  Max: {{ getMaxMergeAmount() }}
                </small> -->
              </div>
  
              <div class="alert alert-info">
                <small>
                  <strong>You will receive:</strong> {{ mergeAmount || '0' }} SY tokens
                </small>
              </div>
            }
  
            <button 
              type="submit" 
              class="btn btn-primary w-100"
              [disabled]="!mergeForm.valid || !blockchainService.isConnected() || isProcessing()">
              @if (isProcessing()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Merge to SY
            </button>
          </form>
        </div>
      </div>
  
      <!-- Yield Summary -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-graph-up-arrow me-2"></i>
            Yield Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <h3 class="gradient-text">
              {{ blockchainService.formatBalance(tokenService.getTotalClaimableYield().toString()) }}
            </h3>
            <p class="text-muted mb-0">Total Claimable Yield</p>
          </div>
  
          <div class="d-grid gap-2">
            <button 
              class="btn btn-warning"
              (click)="claimAllYield()"
              [disabled]="tokenService.getTotalClaimableYield() === 0 || isProcessing()">
              @if (isProcessing()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
              }
              Claim All Yield
            </button>
          </div>
  
          <hr>
  
          <div class="row text-center">
            <div class="col-6">
              <h6 class="text-primary">{{ tokenService.ptTokens().length }}</h6>
              <small class="text-muted">PT Positions</small>
            </div>
            <div class="col-6">
              <h6 class="text-warning">{{ tokenService.ytTokens().length }}</h6>
              <small class="text-muted">YT Positions</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  